<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Escolar Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f4f4f4; color: #333; display: flex; height: 100vh; }
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; display: flex; justify-content: center; align-items: center; z-index: 999; }
        .auth-box { background: white; padding: 40px; border-radius: 8px; width: 350px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .auth-box h2 { margin-bottom: 20px; color: #333; }
        .auth-box input, .auth-box select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
        .auth-box button { width: 100%; padding: 12px; background: #2196F3; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; margin-top: 10px; }
        .toggle-link { margin-top: 15px; display: block; color: #2196F3; cursor: pointer; font-size: 0.9em; text-decoration: underline; }
        #app { display: none; width: 100%; display: flex; }
        .sidebar { width: 260px; background: #2d2d2d; color: white; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h2 { margin-bottom: 40px; color: #4caf50; text-align: center; }
        .menu-item { padding: 15px; cursor: pointer; border-radius: 6px; margin-bottom: 8px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover { background: #3d3d3d; }
        .menu-item.active { background: #4caf50; font-weight: bold; }
        .user-info { margin-top: auto; font-size: 0.9em; color: #aaa; border-top: 1px solid #444; padding-top: 20px; }
        .content { flex: 1; padding: 40px; overflow-y: auto; background: #eef2f5; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row input, .form-row select { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button.btn-action { padding: 10px 25px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #666; font-weight: 600; }
        .chart-container { width: 100%; max-width: 700px; margin: auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="auth-screen">
        <div class="auth-box" id="form-login">
            <h2>Acesso Escolar</h2>
            <input type="email" id="email" placeholder="E-mail" value="admin@escola.com">
            <input type="password" id="senha" placeholder="Senha" value="123456">
            <button onclick="fazerLogin()">ENTRAR</button>
            <span class="toggle-link" onclick="alternarAuth()">Criar Conta</span>
        </div>
        <div class="auth-box" id="form-cadastro" style="display: none;">
            <h2>Novo Cadastro</h2>
            <input type="text" id="cad_nome" placeholder="Nome">
            <input type="email" id="cad_email" placeholder="Email">
            <input type="password" id="cad_senha" placeholder="Senha">
            <select id="cad_tipo"><option value="aluno">Aluno</option><option value="professor">Professor</option></select>
            <button onclick="fazerCadastroPublico()" style="background:#4caf50">CADASTRAR</button>
            <span class="toggle-link" onclick="alternarAuth()">Voltar para Login</span>
        </div>
    </div>

    <div id="app">
        <div class="sidebar">
            <h2>üéì Sistema Pro</h2>
            <div class="menu-item active" onclick="mostrar('dashboard')">üìä Dashboard</div>
            <div class="menu-item" onclick="mostrar('notas')">üìù Lan√ßar Notas</div>
            <div class="menu-item" id="menu-usuarios" onclick="mostrar('usuarios')">üë• Usu√°rios</div>
            <div class="menu-item" onclick="location.reload()" style="background:#d32f2f; margin-top:20px">üö™ Sair</div>
            <div class="user-info">Logado: <strong id="user-name">...</strong></div>
        </div>

        <div class="content">
            <div id="dashboard" class="section active">
                <h1>Dashboard</h1>
                <div class="card"><h3>Desempenho</h3><div class="chart-container"><canvas id="graficoNotas"></canvas></div></div>
            </div>
            <div id="notas" class="section">
                <h1>Lan√ßamento de Notas</h1>
                <div class="card">
                    <div class="form-row">
                        <select id="sel_aluno"><option value="">Selecione o Aluno...</option></select>
                        <select id="sel_disc"><option value="">Selecione a Disciplina...</option></select>
                    </div>
                    <div class="form-row"><input type="number" id="n1" placeholder="N1"><input type="number" id="n2" placeholder="N2"><input type="number" id="n3" placeholder="N3"></div>
                    <button class="btn-action" onclick="salvarNota()">Salvar Nota</button>
                </div>
                <div class="card">
                    <h3>Hist√≥rico</h3><table id="tabela-notas"><thead><tr><th>Aluno</th><th>Disciplina</th><th>M√©dia</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
            <div id="usuarios" class="section">
                <h1>Gest√£o de Usu√°rios</h1>
                <div class="card">
                    <div class="form-row"><input type="text" id="novo_nome" placeholder="Nome"><input type="email" id="novo_email" placeholder="Email"></div>
                    <div class="form-row"><input type="password" id="novo_senha" placeholder="Senha"><select id="novo_tipo"><option value="aluno">Aluno</option><option value="professor">Professor</option><option value="administrador">Admin</option></select></div>
                    <button class="btn-action" onclick="criarUsuarioAdmin()">Cadastrar Usu√°rio</button>
                </div>
                <div class="card"><table><thead><tr><th>Nome</th><th>Email</th><th>Tipo</th><th>A√ß√£o</th></tr></thead><tbody id="tabela-usuarios"></tbody></table></div>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://127.0.0.1:3000';
        let usuarioLogado = null;

        // --- L√ìGICA INTELIGENTE ---
        async function carregarDropdowns() {
            // Pega alunos e disciplinas
            const alunos = await (await fetch(`${API}/alunos-lista`)).json();
            const disc = await (await fetch(`${API}/disciplinas-lista`)).json();
            
            // Preenche Alunos
            const selAluno = document.getElementById('sel_aluno');
            if(alunos.length === 0) selAluno.innerHTML = '<option>Nenhum aluno cadastrado</option>';
            else selAluno.innerHTML = '<option value="">Selecione o Aluno...</option>' + alunos.map(a => `<option value="${a.id}">${a.nome}</option>`).join('');

            // Preenche Disciplinas
            const selDisc = document.getElementById('sel_disc');
            if(disc.length === 0) selDisc.innerHTML = '<option>Nenhuma disciplina</option>';
            else selDisc.innerHTML = '<option value="">Selecione a Disciplina...</option>' + disc.map(d => `<option value="${d.id}">${d.nome}</option>`).join('');
        }

        async function criarUsuarioAdmin() {
            const corpo = { nome: document.getElementById('novo_nome').value, email: document.getElementById('novo_email').value, senha: document.getElementById('novo_senha').value, tipo: document.getElementById('novo_tipo').value };
            if(!corpo.nome || !corpo.email) return alert("Preencha tudo!");

            const res = await fetch(`${API}/usuarios`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(corpo) });
            const data = await res.json();

            if(res.ok) {
                alert("‚úÖ Cadastrado!");
                carregarUsuarios();
                carregarDropdowns(); // <--- ATUALIZA A LISTA DE NOTAS NA HORA!
                document.getElementById('novo_nome').value = '';
                document.getElementById('novo_email').value = '';
                document.getElementById('novo_senha').value = '';
            } else alert("Erro: " + data.error);
        }

        // --- RESTO DO SISTEMA ---
        function alternarAuth() {
            const l = document.getElementById('form-login'); const c = document.getElementById('form-cadastro');
            if(l.style.display==='none'){l.style.display='block';c.style.display='none'}else{l.style.display='none';c.style.display='block'}
        }
        async function fazerCadastroPublico(){
            // Igual ao admin, mas volta pro login
            const corpo = { nome: document.getElementById('cad_nome').value, email: document.getElementById('cad_email').value, senha: document.getElementById('cad_senha').value, tipo: document.getElementById('cad_tipo').value };
            const res = await fetch(`${API}/usuarios`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(corpo) });
            if(res.ok){ alert("Conta criada!"); alternarAuth(); } else alert("Erro no cadastro");
        }
        async function fazerLogin(){
            try {
                const res = await fetch(`${API}/login`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email: document.getElementById('email').value, senha: document.getElementById('senha').value }) });
                if(res.ok){ usuarioLogado = await res.json(); iniciarSistema(); } else alert("Dados inv√°lidos");
            } catch(e){ alert("Servidor desligado?"); }
        }
        function iniciarSistema(){
            document.getElementById('auth-screen').style.display='none'; document.getElementById('app').style.display='flex';
            document.getElementById('user-name').innerText = usuarioLogado.nome;
            if(usuarioLogado.tipo !== 'administrador') document.getElementById('menu-usuarios').style.display='none';
            carregarDropdowns(); carregarNotas(); carregarGrafico();
            if(usuarioLogado.tipo === 'administrador') carregarUsuarios();
        }
        function mostrar(id){
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
            document.getElementById(id).classList.add('active'); if(id==='dashboard') carregarGrafico();
        }
        async function carregarUsuarios(){ const u = await(await fetch(`${API}/usuarios`)).json(); document.getElementById('tabela-usuarios').innerHTML = u.map(x=>`<tr><td>${x.nome}</td><td>${x.email}</td><td>${x.tipo}</td><td><button onclick="deletarUser(${x.id})" style="color:red;border:none">X</button></td></tr>`).join(''); }
        async function deletarUser(id){ if(confirm('Apagar?')){ await fetch(`${API}/usuarios/${id}`,{method:'DELETE'}); carregarUsuarios(); carregarDropdowns(); } }
        async function salvarNota(){
            const corpo = { id_aluno: document.getElementById('sel_aluno').value, id_disciplina: document.getElementById('sel_disc').value, nota1: document.getElementById('n1').value, nota2: document.getElementById('n2').value, nota3: document.getElementById('n3').value };
            await fetch(`${API}/notas`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(corpo)}); alert('Salvo!'); carregarNotas();
        }
        async function carregarNotas(){ const n = await(await fetch(`${API}/notas`)).json(); document.querySelector('#tabela-notas tbody').innerHTML = n.map(x=>`<tr><td>${x.aluno}</td><td>${x.disciplina}</td><td><b>${x.media_final}</b></td></tr>`).join(''); }
        let graf = null;
        async function carregarGrafico(){
            const d = await(await fetch(`${API}/relatorios/media-geral`)).json(); const ctx=document.getElementById('graficoNotas').getContext('2d');
            if(graf) graf.destroy(); graf=new Chart(ctx,{type:'bar',data:{labels:d.map(x=>x.disciplina),datasets:[{label:'M√©dia',data:d.map(x=>x.media),backgroundColor:'#4caf50'}]},options:{scales:{y:{beginAtZero:true,max:10}}}});
        }
    </script>
</body>
</html>